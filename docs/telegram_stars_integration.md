# Интеграция Telegram Stars

## Обзор

Telegram Stars - это виртуальная валюта в экосистеме Telegram, которая позволяет пользователям покупать цифровые товары и услуги от ботов и мини-приложений. Наш бот интегрирует систему Telegram Stars для обработки платежей и подписок.

## Принцип работы

### Процесс списания звезд

Согласно официальной документации Telegram, процесс списания звезд включает следующие шаги:

1. **Создание инвойса**: Бот создает инвойс с помощью метода `sendInvoice` с указанием валюты `XTR` (код валюты Telegram Stars).
2. **Предварительная проверка**: Когда пользователь нажимает кнопку оплаты, Telegram отправляет боту запрос `pre_checkout_query`, который бот должен подтвердить.
3. **Завершение платежа**: После успешной оплаты, Telegram отправляет боту сообщение `successful_payment`.

### Проверка баланса

Для проверки баланса звезд пользователя мы используем Telethon (Python-клиент для Telegram API) и метод `GetStarsStatusRequest`.

## Реализация в нашем боте

### TelegramStarsService

Класс `TelegramStarsService` предоставляет следующие методы:

- `get_stars_balance(user_id)`: Получение баланса звезд пользователя
- `create_stars_invoice(title, description, amount)`: Подготовка параметров для создания инвойса
- `deduct_stars(user_id, amount, description)`: Проверка возможности списания звезд

### Обработчики

В файле `telegram_stars_handlers.py` реализованы следующие обработчики:

- `telegram_stars_command`: Обработка команды /stars
- `telegram_stars_menu_handler`: Обработка меню Telegram Stars
- `precheckout_callback`: Обработка предварительной проверки платежа
- `successful_payment_callback`: Обработка успешного платежа
- `check_stars_purchase_handler`: Проверка покупки звезд

## Особенности и ограничения

1. **Прямое списание невозможно**: В текущей версии Telegram API нет прямого метода для списания звезд без участия пользователя. Списание происходит только через процесс оплаты инвойса.

2. **Проверка баланса**: Мы используем несколько методов для проверки баланса с автоматическим переключением между ними в случае ошибки:
   - Сначала пробуем `InputPeerSelf`
   - Затем пробуем `InputPeerUser`
   - В крайнем случае используем тестовую реализацию

3. **Ссылка для покупки**: Используется официальная ссылка `https://t.me/stars/buy` для перенаправления пользователя на страницу покупки звезд Telegram.

## Настройка

Для работы с Telegram Stars API требуются следующие параметры в файле `.env`:

```
TELEGRAM_API_ID=26507863
TELEGRAM_API_HASH=5cb6d934943762a1702333ab205d1f54
TELEGRAM_BOT_TOKEN=your_bot_token
USE_TELEGRAM_STARS=True
```

## Тестирование

Для тестирования платежей через Telegram Stars можно использовать тестовый режим, установив параметр `is_test=True` при создании инвойса. В этом режиме платежи не будут реально списываться.

## Дальнейшие улучшения

1. Добавить кэширование баланса звезд для уменьшения количества запросов к API
2. Реализовать историю транзакций со звездами
3. Добавить автоматическое обновление баланса после успешной покупки
4. Интегрировать систему уведомлений о низком балансе звезд
